#!/usr/bin/env node
"use strict";var fs=require("fs"),path=require("path"),mkdirp=require("mkdirp"),jsdom=require("jsdom"),Q=require("q"),onlyStandAlone=["0117-basic-routing-show-hide-map-example.html"],isAnExample=function(e){return"0000-viewer.html"!==e&&/[0-9][0-9][0-9][0-9].*\.html/.test(e)},isJavascript=function(e){return/.*\.js/.test(e)},deleteFileIfJavascript=function(e){var r=Q.defer();return isJavascript(e)?fs.unlink(e,function(){r.resolve()}):r.resolve(),r.promise},cleanJavascriptFilesFromControllersDirectory=function(e){var r=Q.defer();return fs.readdir(e,function(t,n){var i=[],o=n.map(function(r){return path.join(e,r)});o.forEach(deleteFileIfJavascript),Q.allSettled(i).then(function(e){r.resolve()})}),r.promise},writeController=function(e,r,t){for(var n,i=Q.defer(),o=e.split("\n"),a=[],l=0;l<o.length;l++){var s=o[l];if(""!==s.replace(/^\s+|\s+$/g,"")&&s.search("angular.module")===-1){if(s.search("app.controller")!==-1&&!n){var c=s.match(/app.controller\((\'|\")([^'"]*)/);c&&c.length>2&&c[2]&&(n=c[2]+".js")}a.push(s)}}return n?(n=path.join(t,n),fs.existsSync(n)?(console.log("The controller name is duplicated: "+n),i.reject()):fs.writeFile(n,a.join("\n"),function(){i.resolve()})):(console.log("Can't identify the controller name in the example "+r),i.reject()),i.promise},generateControllersFromExamples=function(e,r){var t=Q.defer();return fs.readdir(e,function(e,n){var i=[];n.forEach(function(e){if(isAnExample(e)){var t=fs.readFileSync(path.join(__dirname,"examples",e));jsdom.env({html:t.toString(),done:function(t,n){var o=n.document.getElementsByTagName("script"),a=o.length-1,l=o[a].innerHTML;i.push(writeController(l,e,r))}})}}),Q.allSettled(i).then(function(){t.resolve()})}),t.promise},extractId=function(e){var r=e.replace(".html","").split("-");return r.splice(0,2),r.join("-")},extractTitle=function(e){for(var r,t=fs.readFileSync(path.join(__dirname,"examples",e)),n=t.toString().split("\n"),i=0;i<n.length;i++){var o=n[i];o.search("<h1>")!==-1&&(r=o.replace("<h1>","").replace("</h1>","").replace(/^ */,""))}return r},extractDescription=function(e){},extractDate=function(e){var r=fs.statSync(e);return r.mtime},generateExamplesJSONFile=function(e,r){var t=Q.defer(),n={};return fs.readdir(e,function(i,o){o.forEach(function(r){if(isAnExample(r)){var t=r.split("-")[1],i=extractId(r),o=r,a=extractTitle(r),l=extractDescription(r),s=extractDate(path.join(e,r));t in n||(n[t]=[]),n[t].push({date:s,section:t,onlyStandAlone:onlyStandAlone.indexOf(o)!==-1,id:"/"+t+"/"+i,extUrl:o,title:a,description:l})}}),fs.writeFile(r,JSON.stringify(n,null,4),function(e){t.resolve()})}),t.promise},controllers_directory=path.join(__dirname,"examples","js","controllers");mkdirp(controllers_directory,function(e){cleanJavascriptFilesFromControllersDirectory(controllers_directory).then(function(){var e=path.join(__dirname,"examples");generateControllersFromExamples(e,controllers_directory).then(function(){var r=path.join(__dirname,"examples","json","examples.json");generateExamplesJSONFile(e,r)})})});